<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:vm="clr-namespace:FreqGen.App.ViewModels"
             xmlns:models="clr-namespace:FreqGen.Presets.Models;assembly=FreqGen.Presets"
             x:Class="FreqGen.App.Views.MainPage"
             x:DataType="vm:MainViewModel"
             Title="FreqGen"
             BackgroundColor="{AppThemeBinding Light={StaticResource White}, Dark={StaticResource Black}}">

  <ScrollView>
    <VerticalStackLayout Padding="20" Spacing="20">

      <!-- Header -->
      <VerticalStackLayout Spacing="5" Margin="0,20,0,10">
        <Label Text="FreqGen"
               FontSize="36"
               FontAttributes="Bold"
               HorizontalOptions="Center" />
        <Label Text="Frequency Therapy"
               FontSize="16"
               TextColor="{StaticResource Gray500}"
               HorizontalOptions="Center" />
      </VerticalStackLayout>

      <!-- Loading Indicator -->
      <ActivityIndicator IsRunning="{Binding IsLoading}"
                         IsVisible="{Binding IsLoading}"
                         Color="{StaticResource Primary}"
                         HeightRequest="50"
                         Margin="0,10" />

      <!-- Error Display -->
      <Border BackgroundColor="{StaticResource Danger}"
              Padding="20"
              StrokeThickness="0"
              StrokeShape="RoundRectangle 12"
              IsVisible="{Binding HasError}"
              Margin="0,5">
        <VerticalStackLayout Spacing="15">
          <HorizontalStackLayout Spacing="10">
            <Label Text="⚠️"
                   FontSize="24"
                   VerticalOptions="Center" />
            <Label Text="Error"
                   FontSize="18"
                   FontAttributes="Bold"
                   TextColor="White"
                   VerticalOptions="Center" />
          </HorizontalStackLayout>

          <Label Text="{Binding ErrorMessage}"
                 FontSize="14"
                 TextColor="White"
                 LineBreakMode="WordWrap"
                 Margin="0,0,0,10" />

          <HorizontalStackLayout Spacing="10" HorizontalOptions="Center">
            <Button Text="Retry Initialization"
                    Command="{Binding RetryInitializationCommand}"
                    BackgroundColor="White"
                    TextColor="{StaticResource Danger}"
                    HeightRequest="44"
                    CornerRadius="10"
                    Padding="20,0"
                    FontAttributes="Bold" />
            <Button Text="Dismiss"
                    Command="{Binding DismissErrorCommand}"
                    BackgroundColor="Transparent"
                    TextColor="White"
                    BorderColor="White"
                    BorderWidth="2"
                    HeightRequest="44"
                    CornerRadius="10"
                    Padding="20,0" />
          </HorizontalStackLayout>
        </VerticalStackLayout>
      </Border>

      <!-- Status Display -->
      <Border BackgroundColor="{AppThemeBinding Light={StaticResource Gray100}, Dark={StaticResource Gray800}}"
              Padding="20"
              StrokeThickness="1"
              Stroke="{AppThemeBinding Light={StaticResource Gray200}, Dark={StaticResource Gray600}}"
              StrokeShape="RoundRectangle 12"
              Margin="0,5">
        <Label Text="{Binding StatusText}"
               FontSize="14"
               LineHeight="1.4"
               HorizontalTextAlignment="Center"
               VerticalTextAlignment="Center"
               LineBreakMode="WordWrap"
               MinimumHeightRequest="60" />
      </Border>

      <!-- Control Buttons -->
      <Grid ColumnDefinitions="*,*" ColumnSpacing="10" Margin="0,5">
        <!-- Stop Button -->
        <Button Grid.Column="0"
                Text="⏹ Stop"
                Command="{Binding StopCommand}"
                BackgroundColor="{StaticResource Danger}"
                TextColor="White"
                HeightRequest="54"
                CornerRadius="12"
                FontSize="16"
                FontAttributes="Bold"
                IsEnabled="{Binding IsPlaying}" />

        <!-- Preset Info (when playing) -->
        <Border Grid.Column="1"
                BackgroundColor="{StaticResource Success}"
                Padding="10"
                StrokeThickness="0"
                StrokeShape="RoundRectangle 12"
                IsVisible="{Binding IsPlaying}">
          <VerticalStackLayout Spacing="2" VerticalOptions="Center">
            <Label Text="▶ Playing"
                   FontSize="12"
                   FontAttributes="Bold"
                   TextColor="White"
                   HorizontalOptions="Center" />
            <Label Text="{Binding CurrentPreset.DisplayName}"
                   FontSize="11"
                   TextColor="White"
                   HorizontalOptions="Center"
                   LineBreakMode="TailTruncation"
                   MaxLines="1" />
          </VerticalStackLayout>
        </Border>
      </Grid>

      <!-- Preset Categories -->
      <VerticalStackLayout Spacing="10"
                          IsEnabled="{Binding IsLoading, Converter={StaticResource InvertedBoolConverter}}"
                          Margin="0,10,0,0">

        <CollectionView ItemsSource="{Binding PresetGroups}"
                        SelectionMode="None">
          <CollectionView.ItemTemplate>
            <DataTemplate x:DataType="vm:PresetGroup">
              <VerticalStackLayout Spacing="12" Margin="0,0,0,30">

                <!-- Category Header -->
                <VerticalStackLayout Spacing="3">
                  <Label Text="{Binding Name}"
                         FontSize="22"
                         FontAttributes="Bold"
                         Margin="0,0,0,2" />
                  <Label Text="{Binding Description}"
                         FontSize="13"
                         TextColor="{StaticResource Gray500}"
                         LineBreakMode="WordWrap"
                         Margin="0,0,0,8" />
                </VerticalStackLayout>

                <!-- Presets in Category -->
                <VerticalStackLayout Spacing="8"
                                    BindableLayout.ItemsSource="{Binding .}">
                  <BindableLayout.ItemTemplate>
                    <DataTemplate x:DataType="models:FrequencyPreset">
                      <Border BackgroundColor="{AppThemeBinding Light={StaticResource Gray200}, Dark={StaticResource Gray800}}"
                              StrokeThickness="1"
                              Stroke="{AppThemeBinding Light={StaticResource Gray300}, Dark={StaticResource Gray600}}"
                              StrokeShape="RoundRectangle 12"
                              Padding="0">
                        <Button Text="{Binding DisplayName}"
                                Command="{Binding Source={RelativeSource AncestorType={x:Type vm:MainViewModel}}, Path=PlayPresetCommand}"
                                CommandParameter="{Binding .}"
                                BackgroundColor="Transparent"
                                TextColor="{AppThemeBinding Light={StaticResource Black}, Dark={StaticResource White}}"
                                HeightRequest="56"
                                CornerRadius="12"
                                FontSize="15"
                                FontAttributes="Bold"
                                HorizontalOptions="Fill"
                                Padding="20,0" />
                      </Border>
                    </DataTemplate>
                  </BindableLayout.ItemTemplate>
                </VerticalStackLayout>

              </VerticalStackLayout>
            </DataTemplate>
          </CollectionView.ItemTemplate>
        </CollectionView>

      </VerticalStackLayout>

      <!-- Footer Info -->
      <VerticalStackLayout Spacing="5" Margin="0,20,0,30" HorizontalOptions="Center">
        <Label Text="FreqGen v1.0"
               FontSize="12"
               TextColor="{StaticResource Gray400}"
               HorizontalOptions="Center" />
        <Label Text="Use headphones for best experience"
               FontSize="11"
               TextColor="{StaticResource Gray400}"
               HorizontalOptions="Center" />
      </VerticalStackLayout>

    </VerticalStackLayout>
  </ScrollView>

</ContentPage>