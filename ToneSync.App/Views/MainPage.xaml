<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:vm="clr-namespace:ToneSync.App.ViewModels"
             xmlns:models="clr-namespace:ToneSync.Presets.Models;assembly=ToneSync.Presets"
             x:Class="ToneSync.App.Views.MainPage"
             x:DataType="vm:MainViewModel"
             Title="ToneSync"
             BackgroundColor="{AppThemeBinding Light={StaticResource White}, Dark={StaticResource Black}}">

  <ScrollView>
    <VerticalStackLayout Padding="20" Spacing="20">

      <!-- Header -->
      <VerticalStackLayout Spacing="5" Margin="0,20,0,10">
        <Label Text="ToneSync"
               FontSize="36"
               FontAttributes="Bold"
               HorizontalOptions="Center" />
        <Label Text="Frequency Therapy"
               FontSize="16"
               TextColor="{StaticResource Gray500}"
               HorizontalOptions="Center" />
      </VerticalStackLayout>

      <!-- Loading Indicator -->
      <ActivityIndicator IsRunning="{Binding IsLoading}"
                         IsVisible="{Binding IsLoading}"
                         Color="{StaticResource Primary}"
                         HeightRequest="50"
                         Margin="0,10" />

      <!-- Initialize Button (explicit, non-magical) -->
      <Button Text="Initialize Audio"
              Command="{Binding InitializeAsyncCommand}"
              IsVisible="{Binding IsInitialized, Converter={StaticResource InvertedBoolConverter}}"
              HeightRequest="54"
              CornerRadius="12"
              FontSize="16"
              FontAttributes="Bold" />

      <!-- Error Display -->
      <Border BackgroundColor="{StaticResource Danger}"
              Padding="20"
              StrokeThickness="0"
              StrokeShape="RoundRectangle 12"
              IsVisible="{Binding HasError}"
              Margin="0,5">
        <VerticalStackLayout Spacing="15">

          <HorizontalStackLayout Spacing="10">
            <Label Text="⚠️"
                   FontSize="24"
                   VerticalOptions="Center" />
            <Label Text="Error"
                   FontSize="18"
                   FontAttributes="Bold"
                   TextColor="White"
                   VerticalOptions="Center" />
          </HorizontalStackLayout>

          <Label Text="{Binding ErrorMessage}"
                 FontSize="14"
                 TextColor="White"
                 LineBreakMode="WordWrap"
                 Margin="0,0,0,10" />

          <HorizontalStackLayout Spacing="10" HorizontalOptions="Center">
            <Button Text="Retry Initialization"
                    Command="{Binding RetryInitializationCommand}"
                    BackgroundColor="White"
                    TextColor="{StaticResource Danger}"
                    HeightRequest="44"
                    CornerRadius="10"
                    Padding="20,0"
                    FontAttributes="Bold" />
            <Button Text="Dismiss"
                    Command="{Binding DismissErrorCommand}"
                    BackgroundColor="Transparent"
                    TextColor="White"
                    BorderColor="White"
                    BorderWidth="2"
                    HeightRequest="44"
                    CornerRadius="10"
                    Padding="20,0" />
          </HorizontalStackLayout>

        </VerticalStackLayout>
      </Border>

      <!-- Output Profile Selector -->
      <Border BackgroundColor="{AppThemeBinding Light={StaticResource Gray100}, Dark={StaticResource Gray800}}"
              Padding="15"
              StrokeThickness="1"
              Stroke="{AppThemeBinding Light={StaticResource Gray200}, Dark={StaticResource Gray600}}"
              StrokeShape="RoundedRectangle 12"
              Margin="0,5">
        <VerticalStackLayout Spacing="8">
          <Label Text="Output Mode"
                 FontSize="14"
                 FontAttributes="Bold"
                 HorizontalTextAlignment="Center" />
          <Picker ItemsSource="{Binding OutputProfiles}"
                  SelectedItem="{Binding OutputProfile, Mode=TwoWay}"
                  Title="Select output"
                  FontSize="14"
                  IsEnabled="{Binding IsPlaying, Converter={StaticResource InvertedBoolConverter}}" />
        </VerticalStackLayout>
      </Border>

      <!-- Master Gain -->
      <Border BackgroundColor="{AppThemeBinding Light={StaticResource Gray100}, Dark={StaticResource Gray800}}"
              Padding="15"
              StrokeThickness="1"
              Stroke="{AppThemeBinding Light={StaticResource Gray200}, Dark={StaticResource Gray600}}"
              StrokeShape="RoundRectangle 12"
              Margin="0,5">

        <VerticalStackLayout Spacing="8">
          <Label Text="Volume"
                 FontSize="14"
                 FontAttributes="Bold"
                 HorizontalTextAlignment="Center" />

          <Slider Minimum="0"
                  Maximum="1"
                  Value="{Binding MasterGain, Mode=TwoWay}"
                  IsEnabled="{Binding IsInitialized}" />

          <Label Text="{Binding MasterGain, StringFormat='{}{0:P0}'}"
                 FontSize="12"
                 HorizontalTextAlignment="Center"
                 TextColor="{StaticResource Gray500}" />
        </VerticalStackLayout>
      </Border>

      <!-- Status Display -->
      <Border BackgroundColor="{AppThemeBinding Light={StaticResource Gray100}, Dark={StaticResource Gray800}}"
              Padding="20"
              StrokeThickness="1"
              Stroke="{AppThemeBinding Light={StaticResource Gray200}, Dark={StaticResource Gray600}}"
              StrokeShape="RoundRectangle 12"
              Margin="0,5">
        <Label Text="{Binding StatusText}"
               FontSize="14"
               LineHeight="1.4"
               HorizontalTextAlignment="Center"
               VerticalTextAlignment="Center"
               LineBreakMode="WordWrap"
               MinimumHeightRequest="60" />
      </Border>

      <!-- Control Buttons -->
      <Grid ColumnDefinitions="*,*" ColumnSpacing="10" Margin="0,5">

        <Button Grid.Column="0"
                Text="⏹ Stop"
                Command="{Binding StopCommand}"
                BackgroundColor="{StaticResource Danger}"
                TextColor="White"
                HeightRequest="54"
                CornerRadius="12"
                FontSize="16"
                FontAttributes="Bold"
                IsEnabled="{Binding IsPlaying}" />

        <Border Grid.Column="1"
                BackgroundColor="{StaticResource Success}"
                Padding="10"
                StrokeThickness="0"
                StrokeShape="RoundRectangle 12"
                IsVisible="{Binding IsPlaying}">
          <VerticalStackLayout Spacing="2" VerticalOptions="Center">
            <Label Text="▶ Playing"
                   FontSize="12"
                   FontAttributes="Bold"
                   TextColor="White"
                   HorizontalOptions="Center" />
            <Label Text="{Binding CurrentPreset.DisplayName}"
                   FontSize="11"
                   TextColor="White"
                   HorizontalOptions="Center"
                   LineBreakMode="TailTruncation"
                   MaxLines="1" />
          </VerticalStackLayout>
        </Border>

      </Grid>

      <!-- Preset Categories -->
      <VerticalStackLayout Spacing="10"
                          IsEnabled="{Binding IsLoading, Converter={StaticResource InvertedBoolConverter}}"
                          Margin="0,10,0,0">

        <CollectionView ItemsSource="{Binding PresetGroups}"
                        SelectionMode="None">
          <CollectionView.ItemTemplate>
            <DataTemplate x:DataType="vm:PresetGroup">

              <VerticalStackLayout Spacing="12" Margin="0,0,0,30">

                <VerticalStackLayout Spacing="3">
                  <Label Text="{Binding Name}"
                         FontSize="22"
                         FontAttributes="Bold" />
                  <Label Text="{Binding Description}"
                         FontSize="13"
                         TextColor="{StaticResource Gray500}" />
                </VerticalStackLayout>

                <VerticalStackLayout Spacing="8"
                                    BindableLayout.ItemsSource="{Binding .}">
                  <BindableLayout.ItemTemplate>
                    <DataTemplate x:DataType="models:FrequencyPreset">
                      <Border BackgroundColor="{AppThemeBinding Light={StaticResource Gray200}, Dark={StaticResource Gray800}}"
                              StrokeThickness="1"
                              Stroke="{AppThemeBinding Light={StaticResource Gray300}, Dark={StaticResource Gray600}}"
                              StrokeShape="RoundRectangle 12">
                        <Button Text="{Binding DisplayName}"
                                Command="{Binding Source={RelativeSource AncestorType={x:Type vm:MainViewModel}}, Path=PlayPresetCommand}"
                                CommandParameter="{Binding .}"
                                BackgroundColor="Transparent"
                                HeightRequest="56"
                                FontSize="15"
                                FontAttributes="Bold"
                                Padding="20,0" />
                      </Border>
                    </DataTemplate>
                  </BindableLayout.ItemTemplate>
                </VerticalStackLayout>

              </VerticalStackLayout>

            </DataTemplate>
          </CollectionView.ItemTemplate>
        </CollectionView>

      </VerticalStackLayout>

      <!-- Footer -->
      <VerticalStackLayout Spacing="5" Margin="0,20,0,30" HorizontalOptions="Center">
        <Label Text="FreqGen v1.0"
               FontSize="12"
               TextColor="{StaticResource Gray400}" />
        <Label Text="Use headphones for best experience"
               FontSize="11"
               TextColor="{StaticResource Gray400}" />
      </VerticalStackLayout>

    </VerticalStackLayout>
  </ScrollView>

</ContentPage>